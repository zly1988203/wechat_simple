var _map,_mapScroll,marker,polygon,_isInitsa=!1,loadMaps=function(a,e){if(!_map){_mapScroll=new IScroll("#mapWrapper"),_map=new AMap.Map("mapContainer",{resizeEnable:!0,zoom:13}),addBeiJing();marker=new AMap.Marker({icon:new AMap.Icon({size:new AMap.Size(25,36),imageSize:new AMap.Size(25,36),image:"../../dist/images/newInnerCity/icon_marker.png"}),position:_map.getCenter()}),_map.on("mapmove",function(){marker.setPosition(_map.getCenter())}),$("#currLocation").on("click",function(){_map.panTo([a,e])}),searchMaps(),_map.on("moveend",function(){searchMaps();var a=polygon.contains(marker.getPosition());0==a&&$("#mapResult li").removeClass("active"),marker.setLabel({content:a?"内部":"外部",offset:new AMap.Pixel(20,0)})})}},searchMaps=function(){AMap.service(["AMap.PlaceSearch"],function(){new AMap.PlaceSearch({pageSize:10,pageIndex:1}).searchNearBy("",_map.getCenter(),200,function(a,e){if("error"!=a&&"no_data"!=a){for(var t=e.poiList.pois,i="",s=0;s<t.length;s++)i+='<li data-name="'+t[s].name+'" data-address="'+t[s].address+'" data-lat="'+t[s].location.lat+'" data-lng="'+t[s].location.lng+'" '+(0==s?'class="active"':"")+'><div class="sui-cell-map-result"><div class="left"><h1>'+t[s].name+"</h1><p>"+t[s].address+'</p></div><div class="right"><button type="button">确定</button></div></div></li>';$("#mapResult").html(i),_mapScroll.refresh(),$("#mapResult li").off("tap").on("tap",function(){$("#mapResult li").removeClass("active"),$(this).addClass("active");var a=$(this).data("lat"),e=$(this).data("lng");marker.setPosition([e,a])}),$("#mapResult button").off("click").on("click",function(){var a=$(this).closest("li");$("#search-address").setPopupData({lat:a.data("lat"),lng:a.data("lng"),name:a.data("name"),address:a.data("address")}),$("#search-address .cancel").triggerHandler("click")})}else $("#mapResult").html("")})})};function addBeiJing(){AMap.service("AMap.DistrictSearch",function(){district=new AMap.DistrictSearch({subdistrict:1,extensions:"all",level:"city"}),district.setLevel("district"),district.search("福田区",function(a,e){var t=e.districtList[0].boundaries,i=[];if(t){for(var s=0,n=t.length;s<n;s++)polygon=new AMap.Polygon({map:_map,strokeWeight:1,path:t[s],fillOpacity:.7,fillColor:"#CCF3FF",strokeColor:"#CC66CC"}),i.push(polygon);_map.setFitView()}})})}AMap.service(["AMap.PlaceSearch"],function(){var a={pageSize:10,pageIndex:1,city:$("#areaCode").val()};placeSearch=new AMap.PlaceSearch(a)});var cpLock=!0;$("#textSearchMap").focus(function(){showSearchAddressPanel()}).off("input").on({compositionstart:function(){cpLock=!1},compositionend:function(){cpLock=!0},input:function(){setTimeout(function(){if(cpLock){var a=$.trim($("#textSearchMap").val());placeSearch.search(a,function(e,t){var i=[];a.length<=0&&(e="no_data"),"complete"==e&&(i=t.poiList.pois);for(var s="",n=0;n<i.length;n++){var r=i[n].name.replace(a,'<span class="imp-blue">'+a+"</span>"),o=i[n].address.replace(a,'<span class="imp-blue">'+a+"</span>");s+='<li data-name="'+i[n].name+'" data-address="'+i[n].address+'" data-lat="'+i[n].location.lat+'" data-lng="'+i[n].location.lng+'"><div class="sui-cell-map"><div class="address">'+r+'</div><div class="city-area">'+o+"</div></div></li>"}$("#searchWrapper ul").html(s),$("#searchWrapper li").off("tap").on("tap",function(){_map.panTo([$(this).data("lng"),$(this).data("lat")]),hideSearchAddressResult()})})}},0)}});var showSearchAddressPanel=function(){if($("#searchWrapper").show(),$(".map-panel").hide(),!_isInitsa){_isInitsa=!0;var a=0,e=0;$("#searchWrapper").on("touchstart",function(){e=$(this).scrollTop(),a=event.touches[0].pageY}),$("#searchWrapper").on("touchmove",function(t){var i=a-t.touches[0].pageY;$(this).scrollTop(i+e)})}},hideSearchAddressResult=function(){$("#searchWrapper").hide(),$(".map-panel").show(),_mapScroll.refresh()};$(function(){loadMaps(parseFloat("116.169465"),parseFloat("39.932670"))});