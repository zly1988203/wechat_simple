var preOrderInfo={price:0,specialPrice:0,businessType:7,specialFlag:""};function getPreOrderInfo(){var e={token:serverUtil.token,busIds:"",sign:serverUtil.sign};request(commuteApi.toAddOrder,e).then(function(e){if(0==e.code){var o=e.data;r(o)}});var r=function(e){$(".head .time").html(e.departTime),$(".head .line-name").html(e.schduleCode),$("#payDays").html("共 "+e.days+" 天"),$("#normalPrice").html(e.price+"元"),$("#specialPrice").html(e.specialPrice+"元"),$("#departTitle").html(e.departTitle),$("#arriveTitle").html(e.arriveTitle),preOrderInfo.price=e.price,preOrderInfo.specialPrice=e.specialPrice,preOrderInfo.specialFlag=parseFloat(e.specialPrice)>0?1:0,$("#payPrice").html(e.payPrice),$(".rule-content").html(e.tipRule),$("#mobile").val(e.contactMobile);preOrderInfo.busId,preOrderInfo.price,parseFloat(preOrderInfo.specialPrice);loadCoupons()}}function loadCoupons(){var e={businessType:preOrderInfo.businessType,busId:preOrderInfo.busId,price:preOrderInfo.price,specialFlag:parseFloat(preOrderInfo.specialPrice)>0?1:0};request(commuteApi.queryConponByBusiness,e).then(function(e){if(0==e.code){var r,o=e.data.list;if(o.length>0)$.each(o,function(e,t){if(0==e)if(1==t.isValid){r={userId:0,isValid:1,recordId:o[0].recordId,amount:o[0].amount,isDiscount:o[0].isDiscount,discountMaxLimitAmount:o[0].discountMaxLimitAmount};var i=JSON.parse(window.localStorage.getItem("userInfo"));r.userId=i.id,localStorage.setItem("selectedCoupon",JSON.stringify(r))}else r={userId:0,isValid:0,recordId:"null",amount:0}});else r={userId:0,isValid:0,recordId:"null",amount:""};calculateCouponPrice(r),calculateTotalPrice()}})}function calculateCouponPrice(e){if(1==e.isValid){var r=parseFloat(preOrderInfo.price)-parseFloat(preOrderInfo.specialPrice);r=parseFloat(r.toFixed(2));var o=e.amount;0==e.isDiscount?r<e.amount&&(o=r):(o=r-(100*r*(100*e.amount)/100/1e3).toFixed(2))>e.discountMaxLimitAmount&&(o=e.discountMaxLimitAmount),o=o.toFixed(2),$("#couponUsePrice").html("-"+o+"元"),$("#couponUsePrice").removeClass("text-gray"),$("#couponUsePrice").addClass("text-red"),$("#couponUsePrice").attr("data-id",e.recordId),$("#couponUsePrice").attr("data-price",o)}else"0"==e.recordId?($("#couponUsePrice").attr("data-price","0"),$("#couponUsePrice").html("不使用优惠券"),$("#couponUsePrice").removeClass("text-red"),$("#couponUsePrice").addClass("text-gray"),$("#couponUsePrice").attr("data-id","")):($("#couponUsePrice").attr("data-price","0"),$("#couponUsePrice").html("无可用优惠券"),$("#couponUsePrice").removeClass("text-red"),$("#couponUsePrice").addClass("text-gray"),$("#couponUsePrice").attr("data-id",""))}function calculateTotalPrice(){var e=parseFloat(preOrderInfo.price)-parseFloat(preOrderInfo.specialPrice),r=$("#couponUsePrice").attr("data-price");r&&null!=r&&(r>e?e=0:e-=r),e=Math.floor(100*e.toFixed(2))/100,$("#payPrice").html(e)}$(".coupon-toggle").off("click").on("click",function(){window.location="/coupon/select?businessType="+preOrderInfo.businessType+"&specialFlag="+preOrderInfo.specialFlag+"&price="+preOrderInfo.price}),$(".back-btn").on("click",function(){window.history.go(-1)}),$(".pay-btn").on("click",function(){var e=$("#mobile").val();if(!/^1\d{10}$/.test(e))return $.toast("请填写正确的手机号"),!1;var r=$("#couponUsePrice").data("id"),o={token:serverUtil.token,qrcId:"",busIds:"",couponId:"",specialPrice:"",ospTraceId:"",sign:serverUtil.sign,orderContactMobile:e};r&&null!=r&&(o.couponId=r),request(commuteApi.addOrder,o).then(function(e){if(0==e.code){var o=e.data,t=(new Base64).encode("/commute/paymentUnit.html?token="+$.cookie("token")+"&orderNo="+o);window.location.href="/order/payunit?orderNo="+o+"&userCouponId="+r+"&url="+t}else 30086==e.code?window.location.href="/commute/commuteOrder/toPaySuccess?orderNo="+e.data:30087==e.code?$.alert("支付失败，已关闭此订单",function(){window.location.href="/commuteIndex"}):30001==e.code?$.alert(e.message,function(){history.go(0)}):88888==e.code?$.alert("10秒之内不允许重复操作下单"):88889==e.code?$.alert("您已存在待支付的订单",function(){window.location.href="/bus/toCommuteOrderDetail?orderNo="+e.data}):88890==e.code?$.alert(e.message,function(){window.location.href="/bus/toCommuteOrderDetail?orderNo="+e.data}):$.alert(e.message)})}),$(function(){getPreOrderInfo()});