var getUrlRequest=getRequest();function getRequest(){var t=location.search,i=new Object;if(-1!=t.indexOf("?")){var a=t.substr(1);strs=a.split("&");for(var e=0;e<strs.length;e++)i[strs[e].split("=")[0]]=unescape(strs[e].split("=")[1])}return i}function isEmpty(t){return null==t||""===t}var _myIScroll,imgUrl="",click_event=isAndroid()?"tap":"click",childLineList=[],lineArr=[],userInfo=JSON.parse(localStorage.getItem("userInfo")),map=new AMap.Map("container",{resizeEnable:!0,zoom:12}),startMarker=new AMap.Marker({map:map,icon:new AMap.Icon({size:new AMap.Size(21,32),imageSize:new AMap.Size(21,32),image:"/dist/images/busCity/icon_up.png",imageOffset:new AMap.Pixel(0,0)}),position:map.getCenter()}),endMarker=new AMap.Marker({map:map,icon:new AMap.Icon({size:new AMap.Size(21,32),imageSize:new AMap.Size(21,32),image:"/dist/images/busCity/icon_down.png",imageOffset:new AMap.Pixel(0,0)}),position:map.getCenter()});function addMark(){lineArr.forEach(function(t,i){var a=t.isStation,e=t.stationName,n=t.time,o=t.imgUrl,s=t.lng,l=t.lat,r=[s,l],d="";isEmpty(o)||(d=' data-img-url="'+o+'"'),new AMap.Marker({map:map,position:r,offset:new AMap.Pixel(-8,-3),content:'<div class="mark-box"><div class="circle-mark" data-isstation="'+a+'" data-name="'+e+'" data-time="'+n+'"'+d+' data-lng="'+s+'" data-lat="'+l+'"></div></div>'}).on("click",function(t){var i=$(t.target.getContentDom()).find(".circle-mark"),a=$(i).data("isstation"),e=$(i).data("name"),n=$(i).data("time");openInfoWindow({imgUrl:$(i).data("img-url"),lng:$(i).data("lng"),lat:$(i).data("lat"),name:e,time:n,isStation:a})})})}function openInfoWindow(t){var i=t.isStation,a=t.name,e=t.time;imgUrl=t.imgUrl;var n="",o="";isEmpty(t.imgUrl)||(n='<div class="window-foot">  <div class="icon-view-img"></div>  <div id="showImg" class="foot-txt">查看图片</div>  <div class="icon-see"></div></div>'),o=0==i?e+"出发":"预计"+e+"到达";var s=[t.lng,t.lat];new AMap.InfoWindow({isCustom:!0,offset:new AMap.Pixel(0,-5),position:s,content:' <div class="simple-content-body">        <div class="simple-window-panel">            <div class="simple-window-title">'+a+'</div>            <div class="simple-window-body">                <div class="info-content">'+o+"</div>            </div>"+n+'        </div>        <div class="ifwn-combo-sharp"></div>    </div>'}).open(map,s)}function animateSwitchDetail(){var t=$(".detail-main-content");if(t.data("toggle")){$(".edit-station").hide(),$(".save-station").show(),t.height(t.data("height")),t.data("toggle",!1),$(".detail-toggle").addClass("turn");var i=$(".detail-head-content").height()+t.data("height")+$(".detail-bottom").height(),a=$(window).height()-i;$(".ola-maps").css({height:a+"px","margin-top":i});var e=$(".detail-station-list").data("real-height"),n=$(".detail-main-content").data("line-height");$(".detail-station-list .before").css({height:e-n+"px",top:n/2+"px",bottom:n/2+"px"})}else{$(".edit-station").show(),$(".save-station").hide(),t.height(80),t.data("toggle",!0),$(".detail-toggle").removeClass("turn");i=$(".detail-head-content").height()+$(".detail-bottom").height(),a=$(window).height()-i;$(".ola-maps").css({height:a+"px","margin-top":i}),$(".detail-station-list .before").removeAttr("style")}}function showSelectedStation(){$(".detail-main-content").data("toggle")?($(".detail-station-list .detail-station-start li").hide(),$(".detail-station-list .detail-station-start li.active").show(),$(".detail-station-list .detail-station-ending li").hide(),$(".detail-station-list .detail-station-ending li.active").show()):($(".detail-station-list .detail-station-start li").show(),$(".detail-station-list .detail-station-ending li").show())}function setMap(){var t=$(window).height()-$(".line-detail").height();$(".ola-maps").css({height:t+"px","margin-top":$(".line-detail").height()})}document.body.addEventListener("touchend",function(t){"showImg"===t.target.id&&($(".img-content img").attr("src",imgUrl),t.stopPropagation(),$("#stationImage").show())},!0),$(".close-img").on("touchend",function(t){$("#stationImage").hide(),t.stopPropagation()});var bindScroll=function(){_myIScroll&&_myIScroll.destroy(),setTimeout(function(){_myIScroll=new IScroll(".detail-main",{click:iScrollClick(),scrollX:!1,scrollY:!0,mouseWheel:!1})},300)};function scrollMiddle(t){var i=0,a=parseInt(t.height()/2),e=t.position().top,n=parseInt($(".detail-main").height()),o=n/2,s=parseInt($(".detail-main .content").height())-n;i=e<o?0:-(e-o+a),Math.abs(i)>s&&(i=-s)}function iScrollClick(){if(/iPhone|iPad|iPod|Macintosh/i.test(navigator.userAgent))return!1;if(/Chrome/i.test(navigator.userAgent))return/Android/i.test(navigator.userAgent);if(/Silk/i.test(navigator.userAgent))return!1;if(/Android/i.test(navigator.userAgent)){var t=navigator.userAgent.substr(navigator.userAgent.indexOf("Android")+8,3);return!(parseFloat(t[0]+t[3])<44)}}function getQueryString(t,i){return i=i||window.location.search,new RegExp("(^|\\?|&)"+t+"=([^&]*)(\\s|&|$)","i").test(i)?decodeURIComponent(RegExp.$2.replace(/\+/g," ")):""}var departStationlnglat=null,arriveStationlnglat=null;function getStationList(){$.showLoading();var t=commuteApi.queryLineDetailByOrder,i={orderNo:getUrlRequest.orderNo,departDate:getUrlRequest.departDate,token:serverUtil.token};$.ajaxService({url:t,data:i,success:function(t){if($.hideLoading(),0==t.code){var i=t.data;$(".depart-date").html(i.departDateStr+"  "+i.arriveStationTime),$(".detail-carNo").html(i.carNo),$(".lineName").html(i.scheduleCode);var a=i.goOnStationList,e=i.goOffStationList;childLineList=JSON.parse(i.childLineList),$("#specialState").val(i.specialState),departStationlnglat=new AMap.LngLat(i.departLng,i.departLat),arriveStationlnglat=new AMap.LngLat(i.arriveLng,i.arriveLat);var n={departTime:i.departTime,specialState:i.specialState,departStationId:i.departStationId,arriveStationId:i.arriveStationId,goOnStationList:a,goOffStationList:e};a.forEach(function(t,i){var a={stationId:t.stationId,stationName:t.stationName,lng:t.longitude,lat:t.latitude,time:calTime(t.departTime),imgUrl:t.stationPicUrl,isStation:0};lineArr.push(a)}),e.forEach(function(t,i){var a={stationId:t.stationId,stationName:t.stationName,lng:t.longitude,lat:t.latitude,time:calTime(t.departTime),imgUrl:t.stationPicUrl,isStation:1};lineArr.push(a)});var o=lineArr[lineArr.length-1],s=new AMap.LngLat(lineArr[0].lng,lineArr[0].lat),l=new AMap.LngLat(o.lng,o.lat),r=Object.assign([],lineArr);r.splice(0,1),r.splice(r.length-1);var d=[];r.forEach(function(t){d.push(new AMap.LngLat(t.lng,t.lat))});var g=d;initShow(n),setMap(),drivingStations(s,l,g)}else $.alert(t.message)},error:function(t){$.hideLoading()}})}function calTime(t,i){isEmpty(i)&&(i=0);var a=new Date(t),e=a.getTime()+60*i*1e3;a.setHours(0),a.setMinutes(0),a.setSeconds(0),a.setMilliseconds(0);var n="";return e-new Date(a.getTime()+864e5)>0&&(n="次日"),e-new Date(a.getTime()+1728e5)>0&&(n="隔日"),n+((e=new Date(e)).getHours()>9?e.getHours():"0"+e.getHours())+":"+(e.getMinutes()>9?e.getMinutes():"0"+e.getMinutes())}function initShow(t){var i="",a=t.goOnStationList;if(a.length>=0){for(var e=!1,n=!1,o=0;o<a.length;o++){var s="途径";0==o&&(s="始发"),i="<li",(d=a[o]).stationId==t.arriveStationId&&(l+=' class="active"'),1==d.sellOutStatus?(e=!0,n=d.stationId==t.departStationId):(e=!1,n=d.stationId==t.departStationId),i+=' data-stationid="'+d.stationId+'" data-lng="'+d.longitude+'"data-sell-out="'+e+'"data-default="'+n+'" data-lat="'+d.latitude+'" data-name="'+d.stationName+'" data-min="'+d.useTime+'" data-img-url="'+d.stationPicUrl+'" data-time="'+d.predictTime+'" data-form="on"> <div class="content"> <div class="name"><h4>'+d.stationName+'</h4><div class="time">（约'+calTime(d.createTime)+'）</div> <div class="item-type">'+s+"</div></div>",i+="</div></li>",$(".detail-station-start").append(i)}stationClickEvent(),getActiveStation()}var l="",r=t.goOffStationList;if(r.length>=0){for(o=0;o<r.length;o++){var d=r[o];s="途径";o==r.length-1&&(s="终点"),l="<li",d.stationId==t.arriveStationId&&(l+=' class="active"'),l+=' data-stationid="'+d.stationId+'" data-lng="'+d.longitude+'" data-lat="'+d.latitude+'" data-name="'+d.stationName+'" data-min="'+d.useTime+'" data-img-url="'+d.stationPicUrl+'" data-time="'+d.predictTime+'" data-form="off"> <div class="content"> <div class="name"><h4>'+d.stationName+'</h4><div class="time">（约'+calTime(d.createTime)+'）</div> <div class="item-type">'+s+"</div></div> </div></li>",$(".detail-station-ending").append(l)}stationClickEvent()}$(".detail-station-list").data("real-height",$(".detail-station-list")[0].scrollHeight),1==a.length&&1==r.length?($(".detail-bottom").hide(),$(".detail-toggle").hide()):($(".detail-bottom").show(),$(".detail-toggle").show()),addMark();var g=$(".detail-main-content").height();$(".detail-main-content").data("height",g);var c=$(".detail-main-content ul li").height();$(".detail-main-content").data("line-height",c),initStationInfo()}function getActiveStation(){for(var t,i,a=$(".detail-station-start li"),e=0;e<a.length;e++){var n=$(a[e]),o=n.data("default"),s=n.data("sell-out");if(o&&!s){t=e;break}if(o&&s)t=e;else if(!o&&s);else if(!o&&!s&&null!=t){i=e;break}}var l=$(a[t]);l.data("sell-out")?$(a[i]).addClass("active").siblings().removeClass("active"):l.addClass("active").siblings().removeClass("active")}function stationClickEvent(){$(".detail-station-list li").on("tap",function(){var t=$(this),i=t.data("lat"),a=t.data("lng"),e=t.data("name"),n=t.data("time"),o=t.data("img-url"),s=t.data("form"),l=null;if(!t.data("sell-out"))return"on"==s?(startMarker.setPosition([a,i]),l=0):(endMarker.setPosition([a,i]),l=1),map.setCenter(new AMap.LngLat(a,i)),openInfoWindow({imgUrl:o,lng:a,lat:i,name:e,time:n,isStation:l}),!t.hasClass("sell-out")&&(t.addClass("active").siblings().removeClass("active"),void scrollMiddle(t))})}function initStationInfo(){var t=$(".detail-station-start li.active"),i=t.data("lat"),a=t.data("lng"),e=t.data("name"),n=t.data("time"),o=t.data("img-url"),s=null;if("on"==t.data("form")?(startMarker.setPosition([a,i]),s=0):(endMarker.setPosition([a,i]),s=1),openInfoWindow({imgUrl:o,lng:a,lat:i,name:e,time:n,isStation:s}),t.hasClass("sell-out"))return!1}function drivingStations(t,i,a){$.showLoading("线路绘制中.....");var e=$(".line-detail").height(),n=$(".line-detail-container .detail-toggle").height(),o=$(".foot-panel").height();$(".sui-mask-transparent").css({height:"auto",top:e+n,bottom:o}),new AMap.Driving({map:map,hideMarkers:!0}).search(t,i,{waypoints:a},function(i,a){"complete"===i?(startMarker.setPosition(departStationlnglat),endMarker.setPosition(arriveStationlnglat),map.setCenter(t),map.setFitView(),$.hideLoading()):console.log("获取驾车数据失败："+a)})}function initPage(){sessionStorage.removeItem("passengerList"),sessionStorage.removeItem("passengerNumber"),getStationList(),$("title").html("线路地图-"+userInfo.providerName)}$(".detail-toggle").on("touchstart",function(){animateSwitchDetail(),showSelectedStation()}),$(function(){initPage()});