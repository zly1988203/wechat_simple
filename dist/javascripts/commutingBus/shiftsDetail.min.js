var getUrlRequest=getRequest();function getRequest(){var t=location.search,a=new Object;if(-1!=t.indexOf("?")){var i=t.substr(1);strs=i.split("&");for(var e=0;e<strs.length;e++)a[strs[e].split("=")[0]]=unescape(strs[e].split("=")[1])}return a}function isEmpty(t){return null==t||""===t}var _myIScroll,imgUrl="",click_event=isAndroid()?"tap":"click",childLineList=[],lineArr=[],userInfo=JSON.parse(localStorage.getItem("userInfo")),map=new AMap.Map("container",{resizeEnable:!0,zoom:12}),startMarker=new AMap.Marker({map:map,icon:new AMap.Icon({size:new AMap.Size(21,32),imageSize:new AMap.Size(21,32),image:"/dist/images/busCity/icon_up.png",imageOffset:new AMap.Pixel(0,0)}),position:map.getCenter()}),endMarker=new AMap.Marker({map:map,icon:new AMap.Icon({size:new AMap.Size(21,32),imageSize:new AMap.Size(21,32),image:"/dist/images/busCity/icon_down.png",imageOffset:new AMap.Pixel(0,0)}),position:map.getCenter()});function addMark(){lineArr.forEach(function(t,a){var i=t.isStation,e=t.stationName,n=t.time,o=t.imgUrl,s=t.lng,l=t.lat,d=[s,l],r="";isEmpty(o)||(r=' data-img-url="'+o+'"'),new AMap.Marker({map:map,position:d,offset:new AMap.Pixel(-8,-3),content:'<div class="mark-box"><div class="circle-mark" data-isstation="'+i+'" data-name="'+e+'" data-time="'+n+'"'+r+' data-lng="'+s+'" data-lat="'+l+'"></div></div>'}).on("click",function(t){var a=$(t.target.getContentDom()).find(".circle-mark"),i=$(a).data("isstation"),e=$(a).data("name"),n=$(a).data("time");openInfoWindow({imgUrl:$(a).data("img-url"),lng:$(a).data("lng"),lat:$(a).data("lat"),name:e,time:n,isStation:i})})})}function openInfoWindow(t){var a=t.isStation,i=t.name,e=t.time;imgUrl=t.imgUrl;var n="",o="";isEmpty(t.imgUrl)||(n='<div class="window-foot">  <div class="icon-view-img"></div>  <div id="showImg" class="foot-txt">查看图片</div>  <div class="icon-see"></div></div>'),o=0==a?e+"出发":"预计"+e+"到达";var s=[t.lng,t.lat];new AMap.InfoWindow({isCustom:!0,offset:new AMap.Pixel(0,-5),position:s,content:' <div class="simple-content-body">        <div class="simple-window-panel">            <div class="simple-window-title">'+i+'</div>            <div class="simple-window-body">                <div class="info-content">'+o+"</div>            </div>"+n+'        </div>        <div class="ifwn-combo-sharp"></div>    </div>'}).open(map,s)}function animateSwitchDetail(){var t=$(".detail-main-content");if(t.data("toggle")){$(".edit-station").hide(),$(".save-station").show(),t.data("toggle",!1),$(".detail-toggle").addClass("turn"),$(".detail-station-start li").length<10?($(".bottomShadow").hide(),$(".detail-station-list").css("margin-bottom",".2rem")):$(".bottomShadow").show();var a=$(".detail-head-content").height()+t.data("height")+$(".detail-bottom").height(),i=$(window).height()-a;$(".ola-maps").css({height:i+"px","margin-top":a});var e=$(".detail-station-list").data("real-height"),n=$(".detail-main-content").data("line-height");$(".detail-station-list .before").css({height:e-n+"px",top:n/2+"px",bottom:n/2+"px"})}else{$(".edit-station").show(),$(".save-station").hide(),t.data("toggle",!0),$(".detail-toggle").removeClass("turn"),$(".bottomShadow").hide(),$(".detail-station-list").css("margin-bottom",".2rem");a=$(".detail-head-content").height()+$(".detail-bottom").height(),i=$(window).height()-a;$(".ola-maps").css({height:i+"px","margin-top":a}),$(".detail-station-list .before").removeAttr("style")}}function showSelectedStation(){$(".detail-main-content").data("toggle")?($(".detail-station-list .detail-station-start li").hide(),$(".detail-station-list .detail-station-start li.active").show(),$(".detail-station-list .detail-station-ending li").hide(),$(".detail-station-list .detail-station-ending li.active").show()):($(".detail-station-list .detail-station-start li").show(),$(".detail-station-list .detail-station-ending li").show())}function setMap(){var t=$(window).height()-$(".line-detail").height();$(".ola-maps").css({height:t+"px","margin-top":$(".line-detail").height()})}document.body.addEventListener("touchend",function(t){"showImg"===t.target.id&&($(".img-content img").attr("src",imgUrl),t.stopPropagation(),$("#stationImage").show())},!0),$(".close-img").on("touchend",function(t){$("#stationImage").hide(),t.stopPropagation()});var bindScroll=function(){_myIScroll&&_myIScroll.destroy(),setTimeout(function(){_myIScroll=new IScroll(".detail-main",{click:iScrollClick(),scrollX:!1,scrollY:!0,mouseWheel:!1})},300)};function scrollMiddle(t){var a=0,i=parseInt(t.height()/2),e=t.position().top,n=parseInt($(".detail-main").height()),o=n/2,s=parseInt($(".detail-main .content").height())-n;a=e<o?0:-(e-o+i),Math.abs(a)>s&&(a=-s)}function iScrollClick(){if(/iPhone|iPad|iPod|Macintosh/i.test(navigator.userAgent))return!1;if(/Chrome/i.test(navigator.userAgent))return/Android/i.test(navigator.userAgent);if(/Silk/i.test(navigator.userAgent))return!1;if(/Android/i.test(navigator.userAgent)){var t=navigator.userAgent.substr(navigator.userAgent.indexOf("Android")+8,3);return!(parseFloat(t[0]+t[3])<44)}}function getQueryString(t,a){return a=a||window.location.search,new RegExp("(^|\\?|&)"+t+"=([^&]*)(\\s|&|$)","i").test(a)?decodeURIComponent(RegExp.$2.replace(/\+/g," ")):""}var departStationlnglat=null,arriveStationlnglat=null;function getStationList(){$.showLoading();var t=commuteApi.queryLineDetail,a={busId:getUrlRequest.busId,token:serverUtil.token};$.ajaxService({url:t,data:a,success:function(t){if($.hideLoading(),0==t.code){var a=t.data;$(".depart-date").html(a.departStationTime),$(".scheduleId").val(a.scheduleId),$(".departDateStr").val(a.departDateStr);var i=a.goOnStationList,e=a.goOffStationList;childLineList=JSON.parse(a.childLineList),$("#specialState").val(a.specialState),departStationlnglat=new AMap.LngLat(a.departLng,a.departLat),arriveStationlnglat=new AMap.LngLat(a.arriveLng,a.arriveLat);var n={departTime:a.departTime,specialState:a.specialState,departStationId:a.departStationId,arriveStationId:a.arriveStationId,goOnStationList:i,goOffStationList:e};i.forEach(function(t,a){var i={stationId:t.stationId,stationName:t.stationName,lng:t.longitude,lat:t.latitude,time:calTime(t.departTime),imgUrl:t.stationPicUrl,isStation:0};lineArr.push(i)}),e.forEach(function(t,a){var i={stationId:t.stationId,stationName:t.stationName,lng:t.longitude,lat:t.latitude,time:calTime(t.departTime),imgUrl:t.stationPicUrl,isStation:1};lineArr.push(i)});var o=lineArr[lineArr.length-1],s=new AMap.LngLat(lineArr[0].lng,lineArr[0].lat),l=new AMap.LngLat(o.lng,o.lat),d=Object.assign([],lineArr);d.splice(0,1),d.splice(d.length-1);var r=[];d.forEach(function(t){r.push(new AMap.LngLat(t.lng,t.lat))});var g=r;initShow(n),setMap(),drivingStations(s,l,g)}else $.alert(t.message)},error:function(t){$.hideLoading()}})}function calTime(t,a){isEmpty(a)&&(a=0);var i=new Date(t),e=i.getTime()+60*a*1e3;i.setHours(0),i.setMinutes(0),i.setSeconds(0),i.setMilliseconds(0);var n="";return e-new Date(i.getTime()+864e5)>0&&(n="次日"),e-new Date(i.getTime()+1728e5)>0&&(n="隔日"),n+((e=new Date(e)).getHours()>9?e.getHours():"0"+e.getHours())+":"+(e.getMinutes()>9?e.getMinutes():"0"+e.getMinutes())}function initShow(t){var a="",i=t.goOnStationList;if(i.length>=0){for(var e=!1,n=!1,o=0;o<i.length;o++){var s="途径";0==o&&(s="始发"),a="<li",(r=i[o]).stationId==t.arriveStationId&&(l+=' class="active"'),1==r.sellOutStatus?(e=!0,n=r.stationId==t.departStationId):(e=!1,n=r.stationId==t.departStationId),a+=' data-stationid="'+r.stationId+'" data-lng="'+r.longitude+'"data-sell-out="'+e+'"data-default="'+n+'" data-lat="'+r.latitude+'" data-name="'+r.stationName+'" data-min="'+r.useTime+'" data-img-url="'+r.stationPicUrl+'" data-time="'+r.predictTime+'" data-form="on"> <div class="content"> <div class="name"><h4 class="stationName">'+r.stationName+'</h4> <div class="item-type">'+s+"</div></div>",1==r.sellOutStatus?a+=" <span>已停售</span>":a+=0!=o?" <span>预计"+calTime(r.departTime)+"</span>":" <span>"+calTime(r.departTime)+"</span>",a+="</div></li>",$(".detail-station-start").append(a),1==r.sellOutStatus&&$(".stationName").addClass("stationNameColor")}stationClickEvent(),getActiveStation()}var l="",d=t.goOffStationList;if(d.length>=0){for(o=0;o<d.length;o++){var r=d[o];s="途径";o==d.length-1&&(s="终点"),l="<li",r.stationId==t.arriveStationId&&(l+=' class="active"'),l+=' data-stationid="'+r.stationId+'" data-lng="'+r.longitude+'" data-lat="'+r.latitude+'" data-name="'+r.stationName+'" data-min="'+r.useTime+'" data-img-url="'+r.stationPicUrl+'" data-time="'+r.predictTime+'" data-form="off"> <div class="content"> <div class="name"><h4 class="stationName">'+r.stationName+'</h4> <div class="item-type">'+s+"</div></div> <span>预计"+calTime(r.departTime)+"</span> </div></li>",$(".detail-station-ending").append(l)}stationClickEvent()}($(".detail-station-list").data("real-height",$(".detail-station-list")[0].scrollHeight),i.length+d.length<10&&($(".bottomShadow").hide(),$(".detail-station-list").css("margin-bottom",".2rem")),1==i.length&&1==d.length)?($(".detail-bottom").hide(),$(".detail-toggle").hide(),$(".stationName").removeClass("hActive"),$(".bottomShadow").hide()):($(".detail-bottom").show(),$(".detail-toggle").show(),$(".detail-toggle").hasClass("turn")?$(".stationName").addClass("hActive"):$(".stationName").removeClass("hActive"));addMark();var g=$(".detail-main-content").height();$(".detail-main-content").data("height",g);var m=$(".detail-main-content ul li").height();$(".detail-main-content").data("line-height",m),initStationInfo()}function getActiveStation(){for(var t,a,i=$(".detail-station-start li"),e=0;e<i.length;e++){var n=$(i[e]),o=n.data("default"),s=n.data("sell-out");if(o&&!s){t=e;break}if(o&&s)t=e;else if(!o&&s);else if(!o&&!s&&null!=t){a=e;break}}var l=$(i[t]);l.data("sell-out")?$(i[a]).addClass("active").siblings().removeClass("active"):l.addClass("active").siblings().removeClass("active")}function stationClickEvent(){$(".detail-station-list li").on("tap",function(){var t=$(this),a=t.data("lat"),i=t.data("lng"),e=t.data("name"),n=t.data("time"),o=t.data("img-url"),s=t.data("form"),l=null;if(!t.data("sell-out"))return"on"==s?(startMarker.setPosition([i,a]),l=0):(endMarker.setPosition([i,a]),l=1),map.setCenter(new AMap.LngLat(i,a)),openInfoWindow({imgUrl:o,lng:i,lat:a,name:e,time:n,isStation:l}),!t.hasClass("sell-out")&&(t.addClass("active").siblings().removeClass("active"),void scrollMiddle(t))})}function initStationInfo(){var t=$(".detail-station-start li.active"),a=t.data("lat"),i=t.data("lng"),e=t.data("name"),n=t.data("time"),o=t.data("img-url"),s=null;if("on"==t.data("form")?(startMarker.setPosition([i,a]),s=0):(endMarker.setPosition([i,a]),s=1),openInfoWindow({imgUrl:o,lng:i,lat:a,name:e,time:n,isStation:s}),t.hasClass("sell-out"))return!1}function drivingStations(t,a,i){$.showLoading("线路绘制中.....");var e=$(".line-detail").height(),n=$(".line-detail-container .detail-toggle").height(),o=$(".foot-panel").height();$(".sui-mask-transparent").css({height:"auto",top:e+n,bottom:o}),new AMap.Driving({map:map,hideMarkers:!0}).search(t,a,{waypoints:i},function(a,i){"complete"===a?(startMarker.setPosition(departStationlnglat),endMarker.setPosition(arriveStationlnglat),map.setCenter(t),map.setFitView(),$.hideLoading()):console.log("获取驾车数据失败："+i)})}function initPage(){sessionStorage.removeItem("passengerList"),sessionStorage.removeItem("passengerNumber"),getStationList(),$("title").html("班线详情-"+userInfo.providerName)}$(".detail-toggle").on("touchstart",function(){animateSwitchDetail(),showSelectedStation(),$(".detail-toggle").hasClass("turn")?$(".stationName").addClass("hActive"):$(".stationName").removeClass("hActive")}),$("#goBack").on(click_event,function(){window.history.go(-1)}),$(function(){initPage()}),$("#chooseData").on("click",function(){var t={scheduleId:$(".scheduleId").val(),departDateStr:$(".departDateStr").val(),startStationName:$(".detail-station-start li.active").find(".stationName").html(),endStationName:$(".detail-station-ending li.active").find(".stationName").html(),startStationId:$(".detail-station-start li.active").attr("data-stationid"),endStationId:$(".detail-station-ending li.active").attr("data-stationid"),startStationTime:$(".detail-station-start li.active").find("span").html(),endStationTime:$(".detail-station-ending li.active").find("span").html()};sessionStorage.setItem("chooseData",JSON.stringify(t)),alert(JSON.stringify(t))});