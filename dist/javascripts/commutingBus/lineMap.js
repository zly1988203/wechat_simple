var getUrlRequest=getRequest();function getRequest(){var t=location.search,a=new Object;if(-1!=t.indexOf("?")){var i=t.substr(1);strs=i.split("&");for(var e=0;e<strs.length;e++)a[strs[e].split("=")[0]]=unescape(strs[e].split("=")[1])}return a}function isEmpty(t){return null==t||""===t}var _myIScroll,imgUrl="",click_event=isAndroid()?"tap":"click",childLineList=[],lineArr=[],userInfo=JSON.parse(localStorage.getItem("userInfo")),map=new AMap.Map("container",{resizeEnable:!0,zoom:12}),startMarker=new AMap.Marker({map:map,icon:new AMap.Icon({size:new AMap.Size(21,32),imageSize:new AMap.Size(21,32),image:"/dist/images/busCity/icon_up.png",imageOffset:new AMap.Pixel(0,0)}),position:map.getCenter()}),endMarker=new AMap.Marker({map:map,icon:new AMap.Icon({size:new AMap.Size(21,32),imageSize:new AMap.Size(21,32),image:"/dist/images/busCity/icon_down.png",imageOffset:new AMap.Pixel(0,0)}),position:map.getCenter()});function addMark(){lineArr.forEach(function(t,a){var i=t.isStation,e=t.stationName,n=t.time,o=t.imgUrl,s=t.lng,l=t.lat,r=[s,l],d="";isEmpty(o)||(d=' data-img-url="'+o+'"'),new AMap.Marker({map:map,position:r,offset:new AMap.Pixel(-8,-3),content:'<div class="mark-box"><div class="circle-mark" data-isstation="'+i+'" data-name="'+e+'" data-time="'+n+'"'+d+' data-lng="'+s+'" data-lat="'+l+'"></div></div>'}).on("click",function(t){var a=$(t.target.getContentDom()).find(".circle-mark"),i=$(a).data("isstation"),e=$(a).data("name"),n=$(a).data("time");openInfoWindow({imgUrl:$(a).data("img-url"),lng:$(a).data("lng"),lat:$(a).data("lat"),name:e,time:n,isStation:i})})})}function openInfoWindow(t){var a=t.isStation,i=t.name,e=t.time;imgUrl=t.imgUrl;var n="",o="";isEmpty(t.imgUrl)||(n='<div class="window-foot">  <div class="icon-view-img"></div>  <div id="showImg" class="foot-txt">查看图片</div>  <div class="icon-see"></div></div>'),o=0==a?e+"出发":"预计"+e+"到达";var s=[t.lng,t.lat];new AMap.InfoWindow({isCustom:!0,offset:new AMap.Pixel(0,-5),position:s,content:' <div class="simple-content-body">        <div class="simple-window-panel">            <div class="simple-window-title">'+i+'</div>            <div class="simple-window-body">                <div class="info-content">'+o+"</div>            </div>"+n+'        </div>        <div class="ifwn-combo-sharp"></div>    </div>'}).open(map,s)}function animateSwitchDetail(){var t=$(".detail-main-content");if(t.data("toggle")){$(".edit-station").hide(),$(".save-station").show(),t.height(t.data("height")),t.data("toggle",!1),$(".detail-toggle").addClass("turn");var a=$(".detail-head-content").height()+t.data("height")+$(".detail-bottom").height(),i=$(window).height()-a;$(".ola-maps").css({height:i+"px","margin-top":a});var e=$(".detail-station-list").data("real-height"),n=$(".detail-main-content").data("line-height");$(".detail-station-list .before").css({height:e-n+"px",top:n/2+"px",bottom:n/2+"px"})}else{$(".edit-station").show(),$(".save-station").hide(),t.height(80),t.data("toggle",!0),$(".detail-toggle").removeClass("turn");a=$(".detail-head-content").height()+$(".detail-bottom").height(),i=$(window).height()-a;$(".ola-maps").css({height:i+"px","margin-top":a}),$(".detail-station-list .before").removeAttr("style")}}function showSelectedStation(){$(".detail-main-content").data("toggle")?($(".detail-station-list .detail-station-start li").hide(),$(".detail-station-list .detail-station-start li.active").show(),$(".detail-station-list .detail-station-ending li").hide(),$(".detail-station-list .detail-station-ending li.active").show()):($(".detail-station-list .detail-station-start li").show(),$(".detail-station-list .detail-station-ending li").show())}function setMap(){var t=$(window).height()-$(".line-detail").height();$(".ola-maps").css({height:t+"px","margin-top":$(".line-detail").height()})}document.body.addEventListener("touchend",function(t){"showImg"===t.target.id&&($(".img-content img").attr("src",imgUrl),t.stopPropagation(),$("#stationImage").show())},!0),$(".close-img").on("touchend",function(t){$("#stationImage").hide(),t.stopPropagation()});var bindScroll=function(){_myIScroll&&_myIScroll.destroy(),setTimeout(function(){_myIScroll=new IScroll(".detail-main",{click:iScrollClick(),scrollX:!1,scrollY:!0,mouseWheel:!1})},300)};function scrollMiddle(t){var a=0,i=parseInt(t.height()/2),e=t.position().top,n=parseInt($(".detail-main").height()),o=n/2,s=parseInt($(".detail-main .content").height())-n;a=e<o?0:-(e-o+i),Math.abs(a)>s&&(a=-s)}function iScrollClick(){if(/iPhone|iPad|iPod|Macintosh/i.test(navigator.userAgent))return!1;if(/Chrome/i.test(navigator.userAgent))return/Android/i.test(navigator.userAgent);if(/Silk/i.test(navigator.userAgent))return!1;if(/Android/i.test(navigator.userAgent)){var t=navigator.userAgent.substr(navigator.userAgent.indexOf("Android")+8,3);return!(parseFloat(t[0]+t[3])<44)}}function getQueryString(t,a){return a=a||window.location.search,new RegExp("(^|\\?|&)"+t+"=([^&]*)(\\s|&|$)","i").test(a)?decodeURIComponent(RegExp.$2.replace(/\+/g," ")):""}var departStationlnglat=null,arriveStationlnglat=null;function getStationList(){$.showLoading();var t=commuteApi.queryLineDetailByOrder,a={orderNo:getUrlRequest.orderNo,departDate:getUrlRequest.departDate,token:serverUtil.token};$.ajaxService({url:t,data:a,success:function(t){if($.hideLoading(),0==t.code){var a=t.data;$(".depart-date").html(a.departDateStr+"  "+a.arriveStationTime),$(".detail-carNo").html(a.carNo),$(".lineName").html(a.scheduleCode);var i=a.goOnStationList,e=a.goOffStationList;childLineList=JSON.parse(a.childLineList),$("#specialState").val(a.specialState),departStationlnglat=new AMap.LngLat(a.departLng,a.departLat),arriveStationlnglat=new AMap.LngLat(a.arriveLng,a.arriveLat);var n={departTime:a.departTime,specialState:a.specialState,departStationId:a.departStationId,arriveStationId:a.arriveStationId,goOnStationList:i,goOffStationList:e};i.forEach(function(t,a){var i={stationId:t.stationId,stationName:t.stationName,lng:t.longitude,lat:t.latitude,time:calTime(t.departTime),imgUrl:t.stationPicUrl,isStation:0};lineArr.push(i)}),e.forEach(function(t,a){var i={stationId:t.stationId,stationName:t.stationName,lng:t.longitude,lat:t.latitude,time:calTime(t.departTime),imgUrl:t.stationPicUrl,isStation:1};lineArr.push(i)});var o=lineArr[lineArr.length-1],s=new AMap.LngLat(lineArr[0].lng,lineArr[0].lat),l=new AMap.LngLat(o.lng,o.lat),r=Object.assign([],lineArr);r.splice(0,1),r.splice(r.length-1);var d=[];r.forEach(function(t){d.push(new AMap.LngLat(t.lng,t.lat))});var g=d;initShow(n),setMap(),drivingStations(s,l,g)}else $.alert(t.message)},error:function(t){$.hideLoading()}})}function calTime(t,a){isEmpty(a)&&(a=0);var i=new Date(t),e=i.getTime()+60*a*1e3;i.setHours(0),i.setMinutes(0),i.setSeconds(0),i.setMilliseconds(0);var n="";return 0<e-new Date(i.getTime()+864e5)&&(n="次日"),0<e-new Date(i.getTime()+1728e5)&&(n="隔日"),n+(9<(e=new Date(e)).getHours()?e.getHours():"0"+e.getHours())+":"+(9<e.getMinutes()?e.getMinutes():"0"+e.getMinutes())}function initShow(t){var a="",i=t.goOnStationList;if(0<=i.length){for(var e=!1,n=!1,o=0;o<i.length;o++){var s="途径";0==o&&(s="始发"),a="<li",(d=i[o]).stationId==t.arriveStationId&&(l+=' class="active"'),n=(e=1==d.sellOutStatus,d.stationId==t.departStationId),a+=' data-stationid="'+d.stationId+'" data-lng="'+d.longitude+'"data-sell-out="'+e+'"data-default="'+n+'" data-lat="'+d.latitude+'" data-name="'+d.stationName+'" data-min="'+d.useTime+'" data-img-url="'+d.stationPicUrl+'" data-time="'+d.predictTime+'" data-form="on"> <div class="content"> <div class="name"><h4>'+d.stationName+'</h4><div class="time">（约'+calTime(d.createTime)+'）</div> <div class="item-type">'+s+"</div></div>",a+="</div></li>",$(".detail-station-start").append(a)}stationClickEvent(),getActiveStation()}var l="",r=t.goOffStationList;if(0<=r.length){for(o=0;o<r.length;o++){var d=r[o];s="途径";o==r.length-1&&(s="终点"),l="<li",d.stationId==t.arriveStationId&&(l+=' class="active"'),l+=' data-stationid="'+d.stationId+'" data-lng="'+d.longitude+'" data-lat="'+d.latitude+'" data-name="'+d.stationName+'" data-min="'+d.useTime+'" data-img-url="'+d.stationPicUrl+'" data-time="'+d.predictTime+'" data-form="off"> <div class="content"> <div class="name"><h4>'+d.stationName+'</h4><div class="time">（约'+calTime(d.createTime)+'）</div> <div class="item-type">'+s+"</div></div> </div></li>",$(".detail-station-ending").append(l)}stationClickEvent()}($(".detail-station-list").data("real-height",$(".detail-station-list")[0].scrollHeight),1==i.length&&1==r.length)?($(".detail-bottom").hide(),$(".detail-toggle").hide(),$(".name").removeClass("hActive")):($(".detail-bottom").show(),$(".detail-toggle").show(),$(".detail-toggle").hasClass("turn")?$(".name").addClass("hActive"):$(".name").removeClass("hActive"));addMark();var g=$(".detail-main-content").height();$(".detail-main-content").data("height",g);var c=$(".detail-main-content ul li").height();$(".detail-main-content").data("line-height",c),initStationInfo()}function getActiveStation(){for(var t,a,i=$(".detail-station-start li"),e=0;e<i.length;e++){var n=$(i[e]),o=n.data("default"),s=n.data("sell-out");if(o&&!s){t=e;break}if(o&&s)t=e;else if(!o&&s);else if(!o&&!s&&null!=t){a=e;break}}var l=$(i[t]);l.data("sell-out")?$(i[a]).addClass("active").siblings().removeClass("active"):l.addClass("active").siblings().removeClass("active")}function stationClickEvent(){$(".detail-station-list li").on("tap",function(){var t=$(this),a=t.data("lat"),i=t.data("lng"),e=t.data("name"),n=t.data("time"),o=t.data("img-url"),s=t.data("form"),l=null;if(!t.data("sell-out"))return l="on"==s?(startMarker.setPosition([i,a]),0):(endMarker.setPosition([i,a]),1),map.setCenter(new AMap.LngLat(i,a)),openInfoWindow({imgUrl:o,lng:i,lat:a,name:e,time:n,isStation:l}),!t.hasClass("sell-out")&&(t.addClass("active").siblings().removeClass("active"),void scrollMiddle(t))})}function initStationInfo(){var t=$(".detail-station-start li.active"),a=t.data("lat"),i=t.data("lng"),e=t.data("name"),n=t.data("time");if(openInfoWindow({imgUrl:t.data("img-url"),lng:i,lat:a,name:e,time:n,isStation:"on"==t.data("form")?(startMarker.setPosition([i,a]),0):(endMarker.setPosition([i,a]),1)}),t.hasClass("sell-out"))return!1}function drivingStations(i,t,a){$.showLoading("线路绘制中.....");var e=$(".line-detail").height(),n=$(".line-detail-container .detail-toggle").height(),o=$(".foot-panel").height();$(".sui-mask-transparent").css({height:"auto",top:e+n,bottom:o}),new AMap.Driving({map:map,hideMarkers:!0}).search(i,t,{waypoints:a},function(t,a){"complete"===t?(startMarker.setPosition(departStationlnglat),endMarker.setPosition(arriveStationlnglat),map.setCenter(i),map.setFitView(),$.hideLoading()):console.log("获取驾车数据失败："+a)})}$(".detail-toggle").on("touchstart",function(){animateSwitchDetail(),showSelectedStation(),$(".detail-toggle").hasClass("turn")?$(".name").addClass("hActive"):$(".name").removeClass("hActive")}),$(function(){sessionStorage.removeItem("passengerList"),sessionStorage.removeItem("passengerNumber"),getStationList(),$("title").html("线路地图 - "+userInfo.providerName)});