<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>中交出行</title>
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <link href="../../dist/stylesheets/simpleui.min.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="../../dist/stylesheets/base/vectors.2.css">
    <link href="../../dist/stylesheets/my/my-ticket.css" rel="stylesheet" type="text/css">
</head>

<body>

    <div class="my-ticket">
        <div class="item">
            <div class="box content">
                <div class="left">
                    <div class="time">1月2日 8:36  <span class="text-gray">（共3张）</span></div>
                    <div class="station">
                        <div class="station-item">
                            <div class="station-text start">
                                <h4>软件产业基地（学府路）</h4>
                            </div>
                        </div>
                        <div class="station-item">
                            <div class="station-text end">
                                <h4>西乡客运站</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="right">
                    <div class="thumb" data-href="#">
                        <i></i>
                        <p>查看站点</p>
                    </div>
                </div>
            </div>

            <!-- wrapper -->
            <div class="box-wrapper">
                <div class="box card">
                    <div class="main">
                        <div class="date">
                            <span>6月17日</span>
                            <span class="number">粤B122323</span>
                        </div>
                        <div class="code">
                            <span>验票码</span>
                            <span class="value">0068</span>
                        </div>
                    </div>
                    <div class="evaluate">
                        <button>查看评价</button>
                    </div>
                    <div class="handle">
                        <button class="showTicket">出示车票</button>
                    </div>
                </div>
                <div class="box card">
                    <div class="main">
                        <div class="date">6月17日</div>
                        <div class="code">
                            <span>验票码</span>
                            <span class="value">0068</span>
                        </div>
                    </div>
                    <div class="evaluate">
                        <button>查看评价</button>
                    </div>
                    <div class="handle">
                        <!-- refund：已退票，success：已验票，out：已过期，wait：待乘车 -->
                        <span class="status refund"></span>
                    </div>
                </div>
                <div class="box card">
                    <div class="main">
                        <div class="seat">
                            <span>座位号</span>
                            <span class="value">03</span>
                        </div>
                        <div class="code">
                            <span>验票码</span>
                            <span class="value">0068</span>
                        </div>
                    </div>
                    <div class="evaluate">
                        <button>立即评价</button>
                    </div>
                    <div class="handle">
                        <span class="status success"></span>
                    </div>
                </div>
                <div class="box card">
                    <div class="main">
                        <div class="date">6月17日</div>
                        <div class="code">
                            <span>验票码</span>
                            <span class="value">0068</span>
                        </div>
                    </div>
                    <div class="handle">
                        <button class="showTicket">出示车票</button>
                    </div>
                </div>
                <div class="box card">
                    <div class="main">
                        <div class="date">6月17日</div>
                        <div class="code">
                            <span>验票码</span>
                            <span class="value">0068</span>
                        </div>
                    </div>
                    <div class="handle">
                        <button class="showTicket">出示车票</button>
                    </div>
                </div>
            </div>

            <div class="box">
                <div class="show-all"><span>展示全部</span></div>
                <div class="foot-btn">退票</div>
            </div>
        </div>

        <div class="item">
            <div class="box content">
                <div class="left">
                    <div class="time">1月2日 8:36  <span class="text-gray">（共3张）</span></div>
                    <div class="station">
                        <div class="station-item">
                            <div class="station-text">
                                <h4>软件产业基地（学府路）</h4>
                            </div>
                        </div>
                        <div class="station-item">
                            <div class="station-text">
                                <h4>西乡客运站</h4>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="right">
                    <div class="number">粤B124233</div>
                    <div class="thumb" data-href="#">
                        <i></i>
                        <p>查看站点</p>
                    </div>
                </div>
            </div>

            <!-- wrapper -->
            <div class="box-wrapper">
                <div class="box card">
                    <div class="main">
                        <div class="code">
                            <span>验票码</span>
                            <span class="value">0068</span>
                        </div>
                    </div>
                    <div class="handle">
                        <!-- refund：已退票，success：已验票，out：已过期，wait：待乘车 -->
                        <span class="status out"></span>
                    </div>
                </div>
                <div class="box card">
                    <div class="main">
                        <div class="code">
                            <span>验票码</span>
                            <span class="value">0068</span>
                        </div>
                    </div>
                    <div class="handle">
                        <span class="status wait"></span>
                    </div>
                </div>
            </div>

            <div class="box">
                <!-- 小于或等于三个，可以把“展示全部”去掉 -->
                <div class="show-all"><span>展示全部</span></div>
                <div class="foot-btn">退票</div>
            </div>
        </div>
    </div>

    <script src="../../dist/javascripts/zepto.min.js"></script>
    <script src="../../dist/javascripts/simpleui.min.js"></script>
    <script src="../../dist/javascripts/vectors.min.js"></script>
    <script>
        $(function () {
            /*
             * 触发弹出层
             * */
            $('.showTicket').on('click', function () {
                handleTicket($(this), 5, function () {
                    //todo
                    console.log('success')
                });
            });

            /*
            * 解锁车票
            *
            * param：
            *   el：元素
            *   count：时长
            *   callback：成功后回调函数
            * */
            function handleTicket(el, count, callback) {
                /*
                * 创建图层
                * */
                var _html = '<div class="deblocking">' +
                        '<div class="main">' +
                            '<div class="progress"><span class="bar"></span></div>' +
                            '<div class="content">' +
                                '<h4>长按图片' + count + '秒钟，解锁车票</h4>' +
                                '<p>车票解锁后将不能退款，请慎重操作</p>' +
                                '<div class="thumb longTap"></div>' +
                            '</div>' +
                        '</div>' +
                    '</div>';
                $('body').append(_html);

                /*
                * 关闭弹出层
                * */
                $('.deblocking').off('click').on('click', function (e) {
                    if($(e.target).hasClass('deblocking')) {
                        $('.deblocking').hide(0, function () {
                            $('.deblocking').remove();
                        });
                    }
                });

                /*
                * signal    最长时间
                * step      步长
                * timeAuto  计时器
                * */
                var _self = el;
                var signal = count * 10,
                    step = 100 / signal;
                var timeAuto = null;

                //时间
                if(!_self.data('time')) {
                    _self.data('time', 0);
                } else if(_self.data('time') == signal) {
                    //已解锁
                    $('.progress').show();
                    progress(_self.data('time'));
                    return false;
                }

                var time = _self.data('time');

                $('.deblocking .longTap').on('touchstart', function (e) {
                    //如果已经解锁车票，则不触发
                    if(!_self.data('lock')) {
                        e.preventDefault();

                        //初始化，并计时
                        time = 0;

                        timeAuto = setInterval(function () {
                            //到达最长时长，则隐藏进度条
                            if(time > signal) {
                                clearInterval(timeAuto);
                                success();
                            }

                            time++;
                            progress(time);

                            //持续时间超过100毫秒才展示
                            if(time > 1) {
                                $('.progress').show();
                            }
                        }, 100);
                    }
                }).on('touchend', function () {
                    if(!_self.data('lock')) {
                        clearInterval(timeAuto);

                        //时长少于n秒，则回退到0秒
                        if(time < signal) {
                            time = 0;
                            progress(time);
                            $('.progress').hide();
                        } else {
                            success();
                        }
                    }
                });

                /*
                * 进度条
                * */
                function progress(t) {
                    $('.progress .bar').width(t * step + '%');
                }

                /*
                * 完成
                * */
                function success() {
                    time = signal;
                    progress(time);
                    _self.data('time', signal);
                    _self.data('lock', true);

                    if(callback instanceof Function) {
                        callback();
                    }
                }
            }

            //展示全部
            $('.show-all').each(function () {
                var $el = $(this);
                var $parent = $el.parents('.box').siblings('.box-wrapper');
                var $child = $parent.children();

                //获取前三个的高度之和
                var _MAX_HEIGHT = $child.eq(0).height() + $child.eq(1).height() + $child.eq(2).height();

                //添加和存储最大高度
                $parent.css('max-height', _MAX_HEIGHT);
                $el.data('maxHeight', _MAX_HEIGHT);
            });

            $('.show-all').on('click', function () {
                var $el = $(this);
                var $parent = $el.parents('.box').siblings('.box-wrapper');

                if(!$parent.data('lock')) {
                    $parent.data('lock', true);

                    if(!$el.data('toggle')) {
                        $el.addClass('open');
                        $el.data('toggle', true);

                        //parent
                        $parent.css('max-height', 'none');
                    } else {
                        $el.removeClass('open');
                        $el.data('toggle', false);

                        //parent
                        $parent.css('max-height', $el.data('maxHeight'));
                    }

                    $parent.data('lock', false);
                }

            });
        })
    </script>
</body>
</html>