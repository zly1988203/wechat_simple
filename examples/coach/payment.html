<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>中交出行</title>
    <meta name="viewport" content="width=device-width,user-scalable=no,initial-scale=1.0,maximum-scale=1.0,minimum-scale=1.0">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="email=no">
    <meta http-equiv="X-UA-Compatible" content="chrome=1" />
    <link href="../../dist/stylesheets/simpleui.min.css" rel="stylesheet" type="text/css">
    <link href="../../dist/stylesheets/base/vectors.2.css" rel="stylesheet" type="text/css">
    <link href="../../dist/stylesheets/bus/payment-2.css" rel="stylesheet" type="text/css">
    <link href="../../dist/stylesheets/bus/passenger.css" rel="stylesheet" type="text/css">
    <link href="../../dist/stylesheets/coach/confirm-order.css" rel="stylesheet" type="text/css">
</head>

<body>
    <div class="ticket-info">
        <div class="head">
            <div class="time">9月11日 (周一) 23:00</div>
            <div class="amount">行程约1.5小时</div>
        </div>

        <div class="station">
            <div class="start">深圳湾创业投资大厦</div>
            <div class="end">深圳会展中心</div>
        </div>

        <div class="tips">
            <h4>温馨提示：</h4>
            <p>儿童票、学生票等请前往车站购买。请在发车前提前到站取票，以免耽误行程。距发车时间15分钟内不支持网上退票。</p>
        </div>

        <div class="ticket-rule">取票/退票规则</div>
    </div>

    <!-- 取票/退票规则 - 使用规则 -->
    <div id="ticketRule" class="sui-popup-container">
        <div class="sui-popup-mask"></div>
        <div class="sui-popup-modal">
            <div class="rule-content">
                <div class="close-popup close" data-target="ticketRule"></div>
                <h1>取票/退票规则</h1>
                <P>缺少文案</P>
            </div>
        </div>
    </div>

    <!-- 乘车人：需要乘车人信息 -->
    <div id="passengerWrapper" class="passenger">
        <div class="head sui-border-b">
            <h4>乘车人<span>（最多5位）</span></h4>
            <div class="handle-plus">
                <i id="selectPassengerButton" class="icon-plus"></i>
            </div>
        </div>
        <div class="content">
            <div class="item">
                <div class="handle-minus"></div>
                <div class="name">牛嘎嘎</div>
                <div class="info">
                    <p><span class="label">手机号</span>13632145546</p>
                    <p><span class="label">身份证</span>362531********0027</p>
                </div>
            </div>
            <div class="item">
                <div class="handle-minus"></div>
                <div class="name">李梅梅</div>
                <div class="info">
                    <p><span class="label">手机号</span>13632145546</p>
                    <p><span class="label">身份证</span>362531********0027</p>
                </div>
            </div>
        </div>
    </div>

    <!--乘车人列表-->
    <div id="passengerList" class="sui-popup-container">
        <div class="sui-popup-mask"></div>
        <div class="sui-popup-modal">
            <!--乘车列表-->
            <div class="wrapper listWrapper">
                <div class="content">

                    <div class="passenger-list-wrapper">
                        <ul class="sui-list sui-list-cover sui-border-b">
                            <li class="sui-cell-centerlink add-btn addPassengerButton">添加乘车人</li>
                        </ul>
                        <ul class="passenger-list sui-list sui-list-cover">
                            <!--
                                data-select：是否选中
                                data-name：  姓名
                                data-phone： 手机号码
                                data-code：  身份证号码
                            -->
                            <li class="sui-border-b" data-select="false" data-name="牛嘎嘎" data-phone="151180303494" data-code="440681*********5913">
                                <div class="name">
                                    <input type="checkbox" class="frm-checkbox" />
                                </div>
                                <div class="info">
                                    <h4>牛嘎嘎</h4>
                                    <p><em>手机号</em>151180303494</p>
                                    <p><em>身份证</em>440681*********5913</p>
                                </div>
                                <div class="handle">
                                    <i class="icon-edit editPassengerButton"></i>
                                </div>
                            </li>
                            <li data-select="false" data-name="李梅梅" data-phone="151180303494" data-code="440681*********5913">
                                <div class="name">
                                    <input type="checkbox" class="frm-checkbox" />
                                </div>
                                <div class="info">
                                    <h4>李梅梅</h4>
                                    <p><em>手机号</em>151180303494</p>
                                    <p><em>身份证</em>440681*********5913</p>
                                </div>
                                <div class="handle">
                                    <i class="icon-edit editPassengerButton"></i>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!--
                        没有乘车人

                        1. 将ul.passenger-list 标签里的内容清空
                        2. 隐藏div.btn-bar标签

                        备注：添加一个乘客之后，把div.not-data标签清除，显示div.btn-bar标签
                    -->
                    <!--<div class="not-data" style="background-image: url(../../dist/images/common/icon_no_rider.png);">您当前还未添加乘车人</div>-->

                </div>
            </div>

            <div class="btn-bar pab-10">
                <button id="selectButton">完成</button>
            </div>

        </div>
    </div>

    <!--添加乘车人-->
    <div id="addPassenger" class="sui-popup-container">
        <div class="sui-popup-mask"></div>
        <div class="sui-popup-modal">

            <div class="add-passenger-wrapper">
                <ul class="form sui-list sui-list-cover">
                    <li class="sui-border-b">
                        <label>姓名</label>
                        <input type="text" id="addPassengerName" placeholder="请输入姓名" />
                    </li>
                    <li class="sui-border-b">
                        <label>手机号</label>
                        <input type="text" id="addPassengerPhone" placeholder="请输入手机号" />
                    </li>
                    <li class="sui-border-b">
                        <label>身份证</label>
                        <input type="text" id="addPassengerCode" placeholder="请输入身份证" />
                    </li>
                </ul>
            </div>

            <div class="btn-group">
                <div class="btn default" id="cancelAddButton">取消</div>
                <div class="btn primary" id="submitAddButton">确定</div>
            </div>

        </div>
    </div>

    <!--编辑乘车人-->
    <div id="editPassenger" class="sui-popup-container">
        <div class="sui-popup-mask"></div>
        <div class="sui-popup-modal">

            <div class="edit-passenger-wrapper">
                <ul class="form sui-list sui-list-cover">
                    <li class="sui-border-b">
                        <label>姓名</label>
                        <input type="text" id="editPassengerName" placeholder="请输入姓名" />
                    </li>
                    <li class="sui-border-b">
                        <label>手机号</label>
                        <input type="text" id="editPassengerPhone" placeholder="请输入手机号" />
                    </li>
                    <li class="sui-border-b">
                        <label>身份证</label>
                        <input type="text" id="editPassengerCode" placeholder="请输入身份证" />
                    </li>
                </ul>
            </div>

            <div class="btn-bar pab-10">
                <button id="submitEditButton">确定</button>
            </div>

        </div>
    </div>

    <ul class="coupon-btn sui-list">
        <li>
            <div class="name">票价总额</div>
            <div class="value text-red">11元</div>
        </li>
    </ul>
    
    <ul class="payment-way sui-list sui-border-tb">
		<li>
            <div class="icon icon-1">微信支付<em>（推荐）</em></div>
            <input type="radio" name="pay" class="frm-radio" checked />
        </li>
	</ul>

    <div class="btn-bar pab-10">
        <button>确认支付20元</button>
    </div>
    
    <script src="../../dist/javascripts/zepto.min.js"></script>
    <script src="../../dist/javascripts/simpleui.min.js"></script>
    <script src="../../dist/javascripts/vectors.min.js"></script>
    <script>
    // 绑定滚动条
    var _myIScroll;
    var bindScroll = function(el) {
        if(_myIScroll) {
            _myIScroll.destroy();
        }
        setTimeout(function() {
            _myIScroll = new IScroll(el + ' .listWrapper');
        }, 300);
    }

    $('.listWrapper').each(function () {
        $(this).css('height', ($(window).height() - 74) + 'px');
    });

    /*
    * 乘客 - 操作
    * */
    function passengerHandle() {
        // 打开选择乘车人列表
        $('#selectPassengerButton').on('click', function() {
            $('#passengerList').popup('modal', function() {
                bindScroll('#passengerList');  //加载滚动条
            });
        });

        //点击内容区，自动选中或取消
        function triggerCheckbox($el) {
            var $input = $el.prev('.name').find('input[type=checkbox]');

            if($input.prop('checked')) {
                $input.prop('checked', false);
            } else {
                $input.prop('checked', true);
            }

            changeSelect($input);
        }

        $('#passengerList .passenger-list li .info').on('click', function () {
            triggerCheckbox($(this));
        });

        /*
        * 更新select状态
        * */
        function changeSelect(el) {
            el.parents('li').data('select', el.prop('checked'));
        }

        //选择乘客 - 更新select状态
        $('.passenger-list input[type=checkbox]').on('change', function () {
            changeSelect($(this));
        });

        //确定选择
        $('#selectButton').on('click', function() {
            var _html = '';

            $('.passenger-list li').each(function () {
                var el = $(this);

                if(el.data('select')) {
                    _html += '<div class="item">' +
                        '<div class="handle-minus"></div>' +
                        '<div class="name">' + el.data('name') + '</div>' +
                        '<div class="info">' +
                        '<p><span class="label">手机号</span>' + el.data('phone') + '</p>' +
                        '<p><span class="label">身份证</span>' + el.data('code') + '</p>' +
                        '</div>' +
                        '</div>';
                }
            });

            //更新选中的乘客
            $('#passengerWrapper .content').html('').append(_html);

            $('#passengerList').closePopup();
        });

        /*
        * 添加乘客
        * */
        // 打开添加界面
        $('.addPassengerButton').on('click', function() {
            $('#addPassenger').popup('push', function() {
                $('#name').val('');
                $('#phone').val('');
                $('#code').val('');
            })
        });

        //取消添加
        $('#cancelAddButton').on('click', function () {
            $('#addPassenger').closePopup();
        });

        //提交添加
        $('#submitAddButton').on('click', function() {

            //TODO: 提交添加
            var name = $('#addPassengerName').val();
            var phone = $('#addPassengerPhone').val();
            var code = $('#addPassengerCode').val();

            //创建标签
            var $strLi = $('<li class="sui-border-b" data-select="true" data-name="' + name + '" data-phone="' + phone + '" data-code="' + code + '"></li>'),
                $strName = $('<div class="name"><input type="checkbox" class="frm-checkbox" checked /></div>'),
                $strInfo = $('<div class="info"><h4>' + name + '</h4><p><em>手机号</em>' + phone + '</p><p><em>身份证</em>' + code + '</p></div>'),
                $strHandle = $('<div class="handle"><i class="icon-edit editPassengerButton"></i></div>');

            //合并标签
            $strLi.append($strName).append($strInfo).append($strHandle);

            //添加到父元素里
            $('#passengerList .passenger-list').append($strLi);

            //绑定 - 更新乘客选择
            $strName.find('input[type=checkbox]').on('change', function () {
                changeSelect($(this));
            });

            //绑定 - 编辑乘客
            $strHandle.find('.editPassengerButton').on('click', function () {
                editHandle($(this));
            });

            //绑定 - 点击内容区，自动选中或取消
            $strInfo.on('click', function () {
                triggerCheckbox($(this));
            });

            if(_myIScroll) {
                _myIScroll.refresh();   // 刷新滚动条
            }

            $('#addPassenger').closePopup();
        });

        /*
        * 编辑乘客
        * */
        //编辑操作
        function editHandle(el) {
            var $parent = el.parents('li');
            var _name  = $parent.data('name'),
                _phone = $parent.data('phone'),
                _code  = $parent.data('code');

            $('#editPassenger').popup('push', function() {
                $('#editPassengerName').val(_name);
                $('#editPassengerPhone').val(_phone);
                $('#editPassengerCode').val(_code);

                //设置触发的元素
                $('#editPassenger').data('trigger', $parent.index());
            });
        }

        // 打开编辑界面
        $('.editPassengerButton').on('click', function() {
            editHandle($(this));
        });

        //关闭编辑
        $('#submitEditButton').on('click', function () {
            $('#editPassenger').closePopup(function () {
                var targetZindex = $('#editPassenger').data('trigger'),
                    _target = $('.passenger-list li').eq(targetZindex);
                var _editName = $('#editPassengerName').val(),
                    _phoneName = $('#editPassengerPhone').val(),
                    _codeName = $('#editPassengerCode').val();

                //更新 - 存储数据
                _target.data('name', _editName)
                       .data('phone', _phoneName)
                       .data('code', _codeName);

                //更新 - 展示数据
                _target.find('.info h4').text(_editName);
                _target.find('.info p:first').html('</h4><p><em>手机号</em>' + _phoneName);
                _target.find('.info p:last').html('</h4><p><em>身份证</em>' + _codeName);
            });
        });

        //乘客人数运算
        $('.operation .icon-minus').on('click', function () {
            //减
            var el = $(this);

            if(!el.data('clock')) {
                el.data('clock', true);

                var _v = parseInt(el.next().text());

                if(_v == 5) {
                    el.siblings('.icon-plus').removeClass('out');
                }

                if(_v == 1) {
                    //TODO
//                    $.alert('人数至少为1');
                } else {
                    el.next().text(_v - 1);

                    if(el.next().text() == 1) {
                        el.addClass('out');
                    }
                }

                el.data('clock', false);
            }
        });

        $('.operation .icon-plus').on('click', function () {
            //加
            var el = $(this);

            if(!el.data('clock')) {
                el.data('clock', true);

                var _v = parseInt(el.prev().text());

                if(_v == 1) {
                    el.siblings('.icon-minus').removeClass('out');
                }

                if(_v == 5) {
                    //TODO
//                    $.alert('人数最多5位');
                } else {
                    el.prev().text(_v + 1);

                    if(el.prev().text() == 5) {
                        el.addClass('out');
                    }
                }

                el.data('clock', false);
            }
        });
    }

    $(function() {
        passengerHandle();

        //取票/退票规则
        $('.ticket-rule').on('tap', function(e) {
            e.stopPropagation();
            $('#ticketRule').popup('modal');
        });

        // 选择支付方式
        $('.payment-way li').off('click').on('click', function() {
            $(this).find('input').prop('checked', true);
        });

        //返回键
        back();
    });

    function back() {
        if (window.history && window.history.pushState) {
            var href = window.location.href;
            var level = -1;

            history.pushState({page: 1}, 'page', href);

            //点击返回键
            $(window).on('popstate', function() {
                history.go(level);
            });

            //弹窗层，返回0
            $('#selectPassengerButton, .coupon-toggle, .insurance-toggle, .ticket-rule').on('click.back', function () {
                level = 0;
            });

            //关闭弹窗层，返回-1
            $('#selectButton, #closeCoupon, #closeInsurance').on('click.back', function () {
                level = -1;
            });
        }
    }
    </script>
</body>
</html>